<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞: –û–Ω–ª–∞–π–Ω</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Exo 2', sans-serif;
            background: linear-gradient(135deg, #0c0c1d 0%, #1a1a3e 50%, #0f0f2e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow-x: hidden;
            position: relative;
        }

        /* --- BACKGROUND --- */
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--duration) ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: var(--opacity); transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }

        .planet { position: absolute; border-radius: 50%; opacity: 0.1; z-index: 0; }
        .planet-1 { width: 200px; height: 200px; background: radial-gradient(circle at 30% 30%, #ff00ff, #8000ff); top: 10%; right: 10%; animation: orbit 20s linear infinite; }
        .planet-2 { width: 150px; height: 150px; background: radial-gradient(circle at 30% 30%, #00ffff, #0080ff); bottom: 10%; left: 5%; animation: orbit 25s linear infinite reverse; }
        @keyframes orbit { from { transform: rotate(0deg) translateX(50px) rotate(0deg); } to { transform: rotate(360deg) translateX(50px) rotate(-360deg); } }

        /* --- CONTAINER --- */
        .container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 30px;
            box-shadow: 0 0 60px rgba(0, 255, 255, 0.2), inset 0 0 60px rgba(0, 255, 255, 0.05);
            text-align: center;
            width: 90%;
            max-width: 700px;
            border: 2px solid rgba(0, 255, 255, 0.3);
            position: relative;
            z-index: 1;
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #00ffff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .subtitle { color: #a0a0ff; margin-bottom: 2rem; font-size: 1rem; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI ELEMENTS --- */
        .btn {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }
        .btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 10px 30px rgba(0, 255, 255, 0.6); }
        .btn-secondary { background: linear-gradient(45deg, #ff00ff, #8000ff); box-shadow: 0 0 20px rgba(255, 0, 255, 0.4); }
        .btn-start { background: linear-gradient(45deg, #00ff00, #008000); color: #000; width: 100%; margin-top: 20px; font-size: 1.2rem; }
        .btn-start:disabled { background: linear-gradient(45deg, #555, #333); color: #888; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-back { background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 14px; padding: 10px 25px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        input {
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(0, 255, 255, 0.3);
            width: 100%;
            margin-bottom: 15px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            text-align: center;
        }
        input:focus { outline: none; border-color: #00ffff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }

        .room-code-display {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            padding: 15px;
            border-radius: 15px;
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            margin: 15px 0;
            letter-spacing: 5px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* --- LOBBY GRID --- */
        .lobby-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .team-slot {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            min-height: 60px;
            transition: 0.3s;
            flex-direction: column;
        }
        .team-slot.filled {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            animation: popIn 0.3s ease;
        }
        .team-slot.creator { border-color: #ff00ff; background: rgba(255, 0, 255, 0.1); position: relative; }
        .team-slot.creator::after { content: 'üëë'; position: absolute; top: -10px; right: -5px; font-size: 20px; }
        .team-slot .score-badge {
            font-size: 12px;
            color: #00ffff;
            margin-top: 5px;
            font-family: 'Orbitron';
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- GAME UI --- */
        .game-info { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; font-size: 14px; }
        .info-value { color: #00ffff; font-family: 'Orbitron'; font-weight: bold; }
        
        .question-box { font-size: 1.3rem; margin: 20px 0; color: #fff; min-height: 70px; display: flex; align-items: center; justify-content: center; }
        
        .options button {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 16px;
        }
        .options button:hover:not(:disabled) { background: rgba(0, 255, 255, 0.2); border-color: #00ffff; transform: translateX(5px); }
        
        .options button.correct { background: rgba(0, 255, 0, 0.3) !important; border-color: #00ff00 !important; box-shadow: 0 0 20px rgba(0, 255, 0, 0.5); }
        .options button.wrong { background: rgba(255, 0, 0, 0.3) !important; border-color: #ff0000 !important; opacity: 0.6; }

        .hidden { display: none !important; }
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #00ffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- LEADERBOARD --- */
        .leaderboard {
            margin: 20px 0;
            text-align: left;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border-left: 4px solid #00ffff;
            animation: slideIn 0.3s ease;
        }
        .leaderboard-item:nth-child(1) { 
            border-left-color: #ffd700; 
            background: rgba(255, 215, 0, 0.1);
            font-weight: bold;
            font-size: 1.1rem;
        }
        .leaderboard-item:nth-child(2) { 
            border-left-color: #c0c0c0; 
            background: rgba(192, 192, 192, 0.1);
        }
        .leaderboard-item:nth-child(3) { 
            border-left-color: #cd7f32; 
            background: rgba(205, 127, 50, 0.1);
        }
        .leaderboard-item .rank {
            font-family: 'Orbitron';
            font-size: 1.5rem;
            color: #00ffff;
            margin-right: 15px;
            min-width: 30px;
        }
        .leaderboard-item .team-name {
            flex-grow: 1;
            font-weight: 600;
        }
        .leaderboard-item .team-score {
            font-family: 'Orbitron';
            font-size: 1.3rem;
            color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
        }
        @keyframes slideIn { from { transform: translateX(-30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .trophy {
            font-size: 4rem;
            margin: 10px 0;
            animation: bounce 1s ease infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="planet planet-1"></div>
    <div class="planet planet-2"></div>

    <div class="container">
        <!-- 1. HOME -->
        <div id="screen-home" class="screen active">
            <h1>üöÄ –ö–û–°–ú–ò–ß–ï–°–ö–ê–Ø –í–ò–ö–¢–û–†–ò–ù–ê</h1>
            <p class="subtitle">–°–µ—Ç–µ–≤–∞—è –∏–≥—Ä–∞ –¥–ª—è 7 –∫–ª–∞—Å—Å–∞</p>
            <button class="btn" onclick="goToScreen('screen-create')">üåü –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button class="btn btn-secondary" onclick="goToScreen('screen-lobby-join')">üîë –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        </div>

        <!-- 2. CREATE -->
        <div id="screen-create" class="screen">
            <h1>üåü –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã</h1>
            <p class="subtitle">–ü—Ä–∏–¥—É–º–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã</p>
            <input type="text" id="create-team-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã" maxlength="12">
            <div class="room-code-display" id="generated-code">----</div>
            <p style="color: #a0a0ff; font-size: 13px; margin-bottom: 20px;">
                –û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–∑—å—è–º
            </p>
            <button class="btn" onclick="createRoom()">üì° –ñ–¥–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤</button>
            <button class="btn btn-back" onclick="goToScreen('screen-home')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- 3. JOIN INPUT -->
        <div id="screen-lobby-join" class="screen">
            <h1>üîë –í—Ö–æ–¥ –Ω–∞ –±–æ—Ä—Ç</h1>
            <p class="subtitle">–í–≤–µ–¥–∏ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã –∏ —Å–≤–æ—ë –∏–º—è</p>
            <input type="text" id="join-room-code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (4 —Ü–∏—Ñ—Ä—ã)">
            <input type="text" id="join-team-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã" maxlength="12">
            <button class="btn" onclick="joinRoomRequest()">üõ∏ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button class="btn btn-back" onclick="goToScreen('screen-home')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- 4. LOBBY WAIT -->
        <div id="screen-lobby-wait" class="screen">
            <h1>üì° –û–∂–∏–¥–∞–Ω–∏–µ —ç–∫–∏–ø–∞–∂–∞</h1>
            <p class="subtitle">–ö–æ–º–Ω–∞—Ç–∞: <span id="lobby-room-code" style="color:#00ffff; font-weight:bold;"></span></p>
            
            <div class="lobby-grid" id="teams-grid">
                <!-- Slots generated by JS -->
            </div>

            <div id="creator-controls">
                <p style="color: #00ff00; font-size: 12px; margin-bottom: 5px;">–í—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã</p>
                <button class="btn btn-start" id="btn-start-game" onclick="startGame()">üöÄ –ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
            </div>
            <div id="player-controls" class="hidden">
                <p style="color: #a0a0ff; font-size: 12px;">–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º...</p>
                <div class="loading-spinner"></div>
            </div>
            <button class="btn btn-back" onclick="leaveRoom()" style="margin-top: 20px;">‚ùå –í—ã–π—Ç–∏</button>
        </div>

        <!-- 5. GAME -->
        <div id="screen-game" class="screen">
            <div class="game-info">
                <div>–ö–æ–º–∞–Ω–¥–∞: <span class="info-value" id="game-team">-</span></div>
                <div>–í–æ–ø—Ä–æ—Å: <span class="info-value" id="game-question-num">1</span>/<span id="game-total-questions">50</span></div>
                <div>–°—á—ë—Ç: <span class="info-value" id="game-score">0</span></div>
            </div>
            <div class="question-box" id="question-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="options" id="options-container"></div>
            <p id="wait-message" class="hidden" style="color: #ffff00; margin-top: 20px; font-size: 14px;">–û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É...</p>
        </div>

        <!-- 6. LEADERBOARD / RESULTS -->
        <div id="screen-results" class="screen">
            <h1>üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∏—Å—Å–∏–∏</h1>
            <div class="trophy">üåü</div>
            <p class="subtitle" id="results-subtitle">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</p>
            
            <div class="leaderboard" id="leaderboard-container">
                <!-- Leaderboard items will be inserted here -->
                <div class="loading-spinner"></div>
            </div>
            
            <p id="my-result" style="color: #00ffff; margin: 20px 0; font-weight: bold;"></p>
            
            <button class="btn" onclick="location.reload()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // ==========================================
        // üî• FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDqebE8d-vfQZTa8kA6cQAv_qDdXqhlElo",
            authDomain: "spacequiz-91362.firebaseapp.com",
            databaseURL: "https://spacequiz-91362-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "spacequiz-91362",
            storageBucket: "spacequiz-91362.firebasestorage.app",
            messagingSenderId: "793208735781",
            appId: "1:793208735781:web:1d15b22b37d19270f897cc",
            measurementId: "G-7MJHFXHLZX"
        };
        // ==========================================

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- VISUALS ---
        function createStars() {
            const container = document.getElementById('stars');
            for(let i=0; i<100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random()*100 + '%';
                star.style.top = Math.random()*100 + '%';
                star.style.width = Math.random()*3 + 'px';
                star.style.height = star.style.width;
                star.style.setProperty('--duration', (Math.random()*3+2)+'s');
                star.style.setProperty('--opacity', Math.random());
                container.appendChild(star);
            }
        }
        createStars();

        // --- DATA ---
        const questions = [
            { q: "–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?", a: ["–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω", "–ë–µ—Ä–ª–∏–Ω", "–†–∏–º"], c: 0 },
            { q: "2 + 2 √ó 2 = ?", a: ["6", "8", "4", "10"], c: 0 },
            { q: "–°–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è —Ä–µ–∫–∞?", a: ["–ù–∏–ª", "–ê–º–∞–∑–æ–Ω–∫–∞", "–í–æ–ª–≥–∞", "–ú–∏—Å—Å–∏—Å–∏–ø–∏"], c: 1 },
            { q: "–ü–ª–∞–Ω–µ—Ç –≤ –°–æ–ª–Ω–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ?", a: ["7", "8", "9", "10"], c: 1 },
            { q: "–§–æ—Ä–º—É–ª–∞ –≤–æ–¥—ã?", a: ["CO2", "H2O", "O2", "NaCl"], c: 1 },
            { q: "–°–∞–º–æ–µ –±—ã—Å—Ç—Ä–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ?", a: ["–õ–µ–≤", "–ì–µ–ø–∞—Ä–¥", "–ê–Ω—Ç–∏–ª–æ–ø–∞", "–°–æ–∫–æ–ª"], c: 1 },
            { q: "–ì–∞–≥–∞—Ä–∏–Ω –ø–æ–ª–µ—Ç–µ–ª –≤...", a: ["1959", "1961", "1963", "1965"], c: 1 },
            { q: "–ú–∞—Ç–µ—Ä–∏–∫–æ–≤ –Ω–∞ –ó–µ–º–ª–µ?", a: ["5", "6", "7", "8"], c: 1 },
            { q: "–°–∞–º—ã–π –±–æ–ª—å—à–æ–π –æ–∫–µ–∞–Ω?", a: ["–ê—Ç–ª–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π", "–ò–Ω–¥–∏–π—Å–∫–∏–π", "–¢–∏—Ö–∏–π", "–°–µ–≤–µ—Ä–Ω—ã–π"], c: 2 },
            { q: "–î–Ω–µ–π –≤ –≤–∏—Å–æ–∫–æ—Å–Ω–æ–º –≥–æ–¥—É?", a: ["364", "365", "366", "367"], c: 2 },
            { q: "–ì–∞–∑ –¥–ª—è –¥—ã—Ö–∞–Ω–∏—è?", a: ["–ê–∑–æ—Ç", "–ö–∏—Å–ª–æ—Ä–æ–¥", "–£–≥–ª–µ–∫–∏—Å–ª—ã–π", "–ì–µ–ª–∏–π"], c: 1 },
            { q: "–í—ã—Å–æ—á–∞–π—à–∞—è –≥–æ—Ä–∞?", a: ["–ö2", "–≠–≤–µ—Ä–µ—Å—Ç", "–ö–∏–ª–∏–º–∞–Ω–¥–∂–∞—Ä–æ", "–≠–ª—å–±—Ä—É—Å"], c: 1 },
            { q: "–•—Ä–æ–º–æ—Å–æ–º —É —á–µ–ª–æ–≤–µ–∫–∞?", a: ["42", "44", "46", "48"], c: 2 },
            { q: "–ê–≤—Ç–æ—Ä '–í–æ–π–Ω—ã –∏ –º–∏—Ä–∞'?", a: ["–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", "–ß–µ—Ö–æ–≤", "–¢–æ–ª—Å—Ç–æ–π", "–ü—É—à–∫–∏–Ω"], c: 2 },
            { q: "–°–∞–º–æ–µ –≥–ª—É–±–æ–∫–æ–µ –æ–∑–µ—Ä–æ?", a: ["–í–∏–∫—Ç–æ—Ä–∏—è", "–ë–∞–π–∫–∞–ª", "–¢–∞–Ω–≥–∞–Ω—å–∏–∫–∞", "–í–µ—Ä—Ö–Ω–µ–µ"], c: 1 },
            { q: "–ë–∏—Ç –≤ –±–∞–π—Ç–µ?", a: ["4", "8", "16", "32"], c: 1 },
            { q: "–ñ–∏–¥–∫–∏–π –º–µ—Ç–∞–ª–ª?", a: ["–°–≤–∏–Ω–µ—Ü", "–†—Ç—É—Ç—å", "–ê–ª—é–º–∏–Ω–∏–π", "–¶–∏–Ω–∫"], c: 1 },
            { q: "–¶–≤–µ—Ç–æ–≤ –≤ —Ä–∞–¥—É–≥–µ?", a: ["5", "6", "7", "8"], c: 2 },
            { q: "–°–∞–º–∞—è –±–æ–ª—å—à–∞—è —Å—Ç—Ä–∞–Ω–∞?", a: ["–ö–∏—Ç–∞–π", "–°–®–ê", "–ö–∞–Ω–∞–¥–∞", "–†–æ—Å—Å–∏—è"], c: 3 },
            { q: "–°–ø—É—Ç–Ω–∏–∫ –ó–µ–º–ª–∏?", a: ["–§–æ–±–æ—Å", "–õ—É–Ω–∞", "–ï–≤—Ä–æ–ø–∞", "–¢–∏—Ç–∞–Ω"], c: 1 },
            { q: "–ù–æ–≥ —É –ø–∞—É–∫–∞?", a: ["6", "8", "10", "12"], c: 1 },
            { q: "–í–∏—Ç–∞–º–∏–Ω –æ—Ç —Å–æ–ª–Ω—Ü–∞?", a: ["A", "B", "C", "D"], c: 3 },
            { q: "–°–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ?", a: ["–°–ª–æ–Ω", "–°–∏–Ω–∏–π –∫–∏—Ç", "–ñ–∏—Ä–∞—Ñ", "–ê–∫—É–ª–∞"], c: 1 },
            { q: "–ì—Ä–∞–Ω–µ–π —É –∫—É–±–∞?", a: ["4", "6", "8", "12"], c: 1 },
            { q: "–°–∞–º–∞—è –±–æ–ª—å—à–∞—è –ø–ª–∞–Ω–µ—Ç–∞?", a: ["–°–∞—Ç—É—Ä–Ω", "–Æ–ø–∏—Ç–µ—Ä", "–£—Ä–∞–Ω", "–ù–µ–ø—Ç—É–Ω"], c: 1 },
            { q: "–ó—É–±–æ–≤ —É –≤–∑—Ä–æ—Å–ª–æ–≥–æ?", a: ["28", "30", "32", "34"], c: 2 },
            { q: "–°–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π –æ–∫–µ–∞–Ω?", a: ["–ò–Ω–¥–∏–π—Å–∫–∏–π", "–ê—Ç–ª–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π", "–°–µ–≤. –õ–µ–¥–æ–≤–∏—Ç—ã–π", "–Æ–∂–Ω—ã–π"], c: 2 },
            { q: "–°–µ–∫—É–Ω–¥ –≤ —á–∞—Å–µ?", a: ["3000", "3600", "4000", "4200"], c: 1 },
            { q: "–û—Ä–≥–∞–Ω –æ—á–∏—Å—Ç–∫–∏ –∫—Ä–æ–≤–∏?", a: ["–°–µ—Ä–¥—Ü–µ", "–ü–µ—á–µ–Ω—å", "–ü–æ—á–∫–∏", "–õ–µ–≥–∫–∏–µ"], c: 2 },
            { q: "–°–∞–º—ã–π —Ç–≤–µ—Ä–¥—ã–π –º–∏–Ω–µ—Ä–∞–ª?", a: ["–ì—Ä–∞–Ω–∏—Ç", "–ê–ª–º–∞–∑", "–ö–≤–∞—Ä—Ü", "–ú—Ä–∞–º–æ—Ä"], c: 1 },
            { q: "–í–∞–ª—é—Ç–∞ –Ø–ø–æ–Ω–∏–∏?", a: ["–Æ–∞–Ω—å", "–í–æ–Ω–∞", "–ô–µ–Ω–∞", "–î–æ–ª–ª–∞—Ä"], c: 2 },
            { q: "–•–∏–º–∏—á–µ—Å–∫–∏–π –∑–Ω–∞–∫ –∑–æ–ª–æ—Ç–∞?", a: ["Ag", "Au", "Fe", "Cu"], c: 1 },
            { q: "–°–∫–æ–ª—å–∫–æ –º—É–∑—ã —É –º—É–∑?", a: ["7", "9", "10", "12"], c: 1 },
            { q: "–°–∞–º—ã–π —Ö–æ–ª–æ–¥–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∫?", a: ["–ï–≤—Ä–∞–∑–∏—è", "–ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞", "–°–µ–≤. –ê–º–µ—Ä–∏–∫–∞", "–ê—Ñ—Ä–∏–∫–∞"], c: 1 },
            { q: "–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è?", a: ["HTML", "Python", "CSS", "HTTP"], c: 1 },
            { q: "–ö–æ—Ä–µ–Ω—å –∏–∑ 144?", a: ["10", "11", "12", "14"], c: 2 },
            { q: "–°—Ç–æ–ª–∏—Ü–∞ –°–®–ê?", a: ["–ù—å—é-–ô–æ—Ä–∫", "–í–∞—à–∏–Ω–≥—Ç–æ–Ω", "–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å", "–ß–∏–∫–∞–≥–æ"], c: 1 },
            { q: "–°–∞–º–æ–µ –≥–ª—É–±–æ–∫–æ–µ –º–µ—Å—Ç–æ –≤ –æ–∫–µ–∞–Ω–µ?", a: ["–Ø–≤–∞–Ω—Å–∫–∞—è –≤–ø–∞–¥–∏–Ω–∞", "–ú–∞—Ä–∏–∞–Ω—Å–∫–∞—è –≤–ø–∞–¥–∏–Ω–∞", "–¢–æ–Ω–≥–∞", "–§–∏–ª–∏–ø–ø–∏–Ω—Å–∫–∞—è"], c: 1 },
            { q: "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ—Ä–æ–Ω —É —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞?", a: ["2", "3", "4", "5"], c: 1 },
            { q: "–ö—Ç–æ –æ—Ç–∫—Ä—ã–ª –ê–º–µ—Ä–∏–∫—É?", a: ["–ú–∞–≥–µ–ª–ª–∞–Ω", "–ö–æ–ª—É–º–±", "–í–µ—Å–ø—É—á—á–∏", "–ö—É–∫"], c: 1 },
            { q: "–°–∞–º–∞—è –º–∞–ª–µ–Ω—å–∫–∞—è –ø—Ç–∏—Ü–∞?", a: ["–í–æ—Ä–æ–±–µ–π", "–ö–æ–ª–∏–±—Ä–∏", "–°–∏–Ω–∏—Ü–∞", "–õ–∞—Å—Ç–æ—á–∫–∞"], c: 1 },
            { q: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∫–∏–ø–µ–Ω–∏—è –≤–æ–¥—ã?", a: ["90¬∞C", "100¬∞C", "110¬∞C", "120¬∞C"], c: 1 },
            { q: "–°–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –≤ —Å—É—Ç–∫–∞—Ö?", a: ["12", "24", "48", "36"], c: 1 },
            { q: "–°–∞–º—ã–π –±–æ–ª—å—à–æ–π –æ—Å—Ç—Ä–æ–≤?", a: ["–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä", "–ì—Ä–µ–Ω–ª–∞–Ω–¥–∏—è", "–ù–æ–≤–∞—è –ì–≤–∏–Ω–µ—è", "–ë–æ—Ä–Ω–µ–æ"], c: 1 },
            { q: "–ö—Ç–æ –Ω–∞–ø–∏—Å–∞–ª '–ì–∞–º–ª–µ—Ç–∞'?", a: ["–®–µ–∫—Å–ø–∏—Ä", "–î–∏–∫–∫–µ–Ω—Å", "–•–µ–º–∏–Ω–≥—É—ç–π", "–û—Å—Ç–∏–Ω"], c: 0 },
            { q: "–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ —Ñ–µ–≤—Ä–∞–ª–µ (–æ–±—ã—á–Ω—ã–π)?", a: ["27", "28", "29", "30"], c: 1 },
            { q: "–°–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è –∑–º–µ—è?", a: ["–ö–æ–±—Ä–∞", "–ü–∏—Ç–æ–Ω", "–ê–Ω–∞–∫–æ–Ω–¥–∞", "–ì–∞–¥—é–∫–∞"], c: 2 },
            { q: "–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ—Ç –±–∞—Ä–æ–º–µ—Ç—Ä?", a: ["–í–ª–∞–∂–Ω–æ—Å—Ç—å", "–î–∞–≤–ª–µ–Ω–∏–µ", "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É", "–í–µ—Ç–µ—Ä"], c: 1 },
            { q: "–°–∫–æ–ª—å–∫–æ –≥—Ä–∞–Ω–µ–π —É –∫—É–±–∏–∫–∞ –†—É–±–∏–∫–∞?", a: ["4", "6", "8", "12"], c: 1 },
            { q: "–°–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ª–∞ —É?", a: ["–ß–µ–ª–æ–≤–µ–∫–∞", "–ü—Ç–∏—Ü—ã", "–†—ã–±—ã", "–ó–º–µ–∏"], c: 1 }
        ];

        // --- STATE ---
        const MAX_TEAMS = 8;
        let myRoomId = null;
        let myTeamName = null;
        let isCreator = false;
        let myScore = 0;
        let roomListener = null;
        let gameListener = null;
        let scoresListener = null;
        let currentQIndex = 0;
        let allTeamsScores = {};

        function goToScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- ROOM LOGIC ---
        function createRoom() {
            const name = document.getElementById('create-team-name').value.trim();
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–º–∞–Ω–¥—ã!');
            
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            myRoomId = code;
            myTeamName = name;
            isCreator = true;

            document.getElementById('generated-code').textContent = code;

            db.ref('rooms/' + code).set({
                creator: name,
                teams: [name],
                status: 'waiting',
                currentQuestion: 0,
                scores: { [name]: 0 }
            }).then(() => {
                goToScreen('screen-lobby-wait');
                setupRoomListener(code);
            });
        }

        function joinRoomRequest() {
            const code = document.getElementById('join-room-code').value.trim();
            const name = document.getElementById('join-team-name').value.trim();
            
            if (!code || !name) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
            
            db.ref('rooms/' + code).once('value').then((snapshot) => {
                const room = snapshot.val();
                if (!room) return alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                if (room.status !== 'waiting') return alert('–ò–≥—Ä–∞ —É–∂–µ –∏–¥–µ—Ç –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å!');
                if (room.teams.includes(name)) return alert('–ò–º—è –∑–∞–Ω—è—Ç–æ!');
                if (room.teams.length >= MAX_TEAMS) return alert('–ö–æ–º–Ω–∞—Ç–∞ –ø–æ–ª–Ω–∞!');

                myRoomId = code;
                myTeamName = name;
                isCreator = false;

                room.teams.push(name);
                // Initialize score for new team
                const updates = {
                    teams: room.teams,
                    [`scores/${name}`]: 0
                };
                db.ref('rooms/' + code).update(updates).then(() => {
                    goToScreen('screen-lobby-wait');
                    setupRoomListener(code);
                });
            });
        }

        function leaveRoom() {
            if (myRoomId && myTeamName) {
                db.ref('rooms/' + myRoomId).once('value').then(snapshot => {
                    const room = snapshot.val();
                    if (room && room.teams) {
                        room.teams = room.teams.filter(t => t !== myTeamName);
                        const updates = { teams: room.teams };
                        if (room.scores) {
                            updates[`scores/${myTeamName}`] = null;
                        }
                        if (isCreator) {
                            db.ref('rooms/' + myRoomId).remove();
                        } else {
                            db.ref('rooms/' + myRoomId).update(updates);
                        }
                    }
                });
            }
            location.reload();
        }

        function setupRoomListener(code) {
            document.getElementById('lobby-room-code').textContent = code;
            
            roomListener = db.ref('rooms/' + code).on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                // Update Lobby Grid with scores
                const grid = document.getElementById('teams-grid');
                grid.innerHTML = '';
                for (let i = 0; i < MAX_TEAMS; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'team-slot';
                    if (i < room.teams.length) {
                        slot.classList.add('filled');
                        const teamName = room.teams[i];
                        slot.innerHTML = `<div>${teamName}</div><div class="score-badge">${room.scores?.[teamName] || 0} ‚≠ê</div>`;
                        if (teamName === room.creator) slot.classList.add('creator');
                        if (teamName === myTeamName) slot.style.border = "2px solid #fff";
                    } else {
                        slot.innerHTML = `<div style="opacity:0.5">–ü—É—Å—Ç–æ</div><div class="score-badge">(${i+1})</div>`;
                        slot.style.opacity = "0.3";
                    }
                    grid.appendChild(slot);
                }

                // Update start button state for creator
                const startBtn = document.getElementById('btn-start-game');
                if (isCreator && startBtn) {
                    startBtn.disabled = room.teams.length < 1;
                }

                // Check Status
                if (room.status === 'playing') {
                    startGameClientSide();
                }
            });
        }

        function startGame() {
            db.ref('rooms/' + myRoomId).update({ status: 'playing', currentQuestion: 0 });
        }

        function startGameClientSide() {
            if (roomListener) db.ref('rooms/' + myRoomId).off('value', roomListener);
            
            document.getElementById('creator-controls').classList.add('hidden');
            document.getElementById('player-controls').classList.add('hidden');
            
            myScore = 0;
            currentQIndex = 0;
            document.getElementById('game-team').textContent = myTeamName;
            document.getElementById('game-score').textContent = '0';
            document.getElementById('game-total-questions').textContent = questions.length;
            
            goToScreen('screen-game');
            setupGameListener();
            setupScoresListener();
            loadQuestionUI(questions[0]);
        }

        function setupGameListener() {
            gameListener = db.ref('rooms/' + myRoomId).on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room || room.status !== 'playing') return;

                const qIndex = room.currentQuestion;
                
                if (qIndex >= questions.length) {
                    finishGame();
                    return;
                }

                if (qIndex !== currentQIndex) {
                    currentQIndex = qIndex;
                    document.getElementById('game-question-num').textContent = qIndex + 1;
                    loadQuestionUI(questions[qIndex]);
                }
            });
        }

        function setupScoresListener() {
            scoresListener = db.ref('rooms/' + myRoomId + '/scores').on('value', (snapshot) => {
                allTeamsScores = snapshot.val() || {};
                // Update local score display
                if (allTeamsScores[myTeamName] !== undefined) {
                    myScore = allTeamsScores[myTeamName];
                    document.getElementById('game-score').textContent = myScore;
                }
            });
        }

        function loadQuestionUI(qData) {
            document.getElementById('question-text').textContent = qData.q;
            document.getElementById('wait-message').classList.add('hidden');
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            let answers = qData.a.map((text, idx) => ({ text, isCorrect: idx === qData.c }));
            answers.sort(() => Math.random() - 0.5);

            answers.forEach(ans => {
                const btn = document.createElement('button');
                btn.textContent = ans.text;
                btn.onclick = () => {
                    const allBtns = document.querySelectorAll('.options button');
                    allBtns.forEach(b => b.disabled = true);

                    if (ans.isCorrect) {
                        btn.classList.add('correct');
                        // Update score in Firebase
                        db.ref('rooms/' + myRoomId + '/scores/' + myTeamName).transaction(currentScore => {
                            return (currentScore || 0) + 1;
                        });
                    } else {
                        btn.classList.add('wrong');
                        allBtns.forEach(b => {
                            if (b.textContent === qData.a[qData.c]) {
                                b.classList.add('correct');
                            }
                        });
                    }
                    
                    document.getElementById('wait-message').classList.remove('hidden');
                    document.getElementById('wait-message').textContent = "–û—Ç–≤–µ—Ç –∑–∞–ø–∏—Å–∞–Ω!";

                    // Creator advances the game
                    if (isCreator) {
                        setTimeout(() => {
                            db.ref('rooms/' + myRoomId).transaction(currentData => {
                                if (currentData && currentData.status === 'playing') {
                                    return { ...currentData, currentQuestion: currentData.currentQuestion + 1 };
                                }
                                return currentData;
                            });
                        }, 2500);
                    } else {
                        document.getElementById('wait-message').textContent = "–ñ–¥–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É...";
                    }
                };
                container.appendChild(btn);
            });
        }

        function finishGame() {
            if (gameListener) db.ref('rooms/' + myRoomId).off('value', gameListener);
            if (scoresListener) db.ref('rooms/' + myRoomId + '/scores').off('value', scoresListener);
            
            goToScreen('screen-results');
            showLeaderboard();
        }

        function showLeaderboard() {
            const container = document.getElementById('leaderboard-container');
            
            // Convert scores object to array and sort
            const sortedTeams = Object.entries(allTeamsScores)
                .sort((a, b) => b[1] - a[1]) // Sort by score descending
                .map(([name, score], index) => ({ rank: index + 1, name, score }));

            container.innerHTML = '';
            
            sortedTeams.forEach((team, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.style.animationDelay = `${index * 0.1}s`;
                
                let medal = '';
                if (team.rank === 1) medal = 'ü•á';
                else if (team.rank === 2) medal = 'ü•à';
                else if (team.rank === 3) medal = 'ü•â';
                else medal = `#${team.rank}`;
                
                item.innerHTML = `
                    <span class="rank">${medal}</span>
                    <span class="team-name">${team.name}${team.name === myTeamName ? ' (–≤—ã)' : ''}</span>
                    <span class="team-score">${team.score} ‚≠ê</span>
                `;
                container.appendChild(item);
            });

            // Show personal result
            const myRank = sortedTeams.findIndex(t => t.name === myTeamName) + 1;
            const myFinalScore = allTeamsScores[myTeamName] || 0;
            const total = questions.length;
            
            let praise = "";
            if (myRank === 1) praise = "üèÜ –í—ã –ø–æ–±–µ–¥–∏–ª–∏! –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —á–µ–º–ø–∏–æ–Ω!";
            else if (myRank <= 3) praise = `üåü ${myRank}-–µ –º–µ—Å—Ç–æ! –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!`;
            else if (myFinalScore / total > 0.5) praise = "‚≠ê –•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!";
            else praise = "üöÄ –ù–µ —Å–¥–∞–≤–∞–π—Å—è, –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ–ª—É—á–∏—Ç—Å—è –ª—É—á—à–µ!";
            
            document.getElementById('my-result').textContent = `${praise} –í–∞—à —Å—á—ë—Ç: ${myFinalScore}/${total}`;
        }
    </script>
</body>
</html>